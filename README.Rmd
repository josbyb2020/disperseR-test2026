---
title: "disperseR"
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

<!-- README.md is generated from README.Rmd. Please edit that file -->

# disperseR 0.2.0

Run HYSPLIT many times in parallel and aggregate exposure to ZIP code level.
This fork modernizes the spatial stack (sf/terra) and keeps compatibility with
current R.

## Highlights

- Modern spatial stack (sf, terra) and cleaned dependencies
- Parallel execution with OS-aware strategy
- Built-in helpers for data download, linking, and exposure metrics

## Installation

Not on CRAN yet. Install from GitHub (CRAN instructions will be added once released):

```{r, eval = FALSE}
install.packages("remotes")
remotes::install_github("josbyb2020/disperseR-test2026")
```

If you plan to run HYSPLIT (dispersion or trajectories) or use GDAS1 meteorology,
install `splitr` from GitHub for bundled binaries, or provide your own HYSPLIT
binaries via `binary_path` and `parhplot_path`.

Windows users who build vignettes will need Rtools.

Optional: install `splitr` (HYSPLIT binaries) from GitHub:

```{r, eval = FALSE}
remotes::install_github("rich-iannone/splitr")
```

## Quick start

```{r, eval = FALSE}
library(disperseR)

dirs <- create_dirs(location = "~/disperseR_project")

get_data(
  data = "all",
  start.year = "2005",
  start.month = "01",
  end.year = "2005",
  end.month = "12"
)

check_spatial_packages()
```

## Windows notes

- Use a short, explicit project path (example: `C:/disperseR_project`) to avoid
  Windows path-length limits.
- Parallel runs on Windows use socket clusters. Make sure disperseR is installed
  (not just `devtools::load_all`) or set `mc.cores = 1` for a sequential run.
- If you see `splitr`-related errors, install `splitr` or provide
  `binary_path` and `parhplot_path` explicitly.

## Project layout

- `main/input/zcta_500k`: ZCTA shapefile
- `main/input/hpbl`: PBL height data
- `main/input/meteo`: reanalysis meteorology files
- `main/output/hysplit`: dispersion outputs
- `main/output/ziplinks`: linked ZIP code outputs
- `main/output/rdata`: HyADS matrices
- `main/output/exp`: exposure tables
- `main/output/graph`: plots

## Data requirements

- ZCTA shapefile
- ZCTA to ZIP crosswalk (included)
- NOAA reanalysis meteorology files
- Planetary boundary layer height data
- Units data (included for 1995-2017)

Use `get_data()` to download most inputs automatically.

## Cross-platform notes

- `create_dirs()` defaults to a session temp directory (CRAN-safe). For
  persistent projects, pass an explicit path (especially on Windows or
  network drives).
- HYSPLIT binaries are required for dispersion runs. If `splitr` is installed,
  disperseR will use its bundled binaries; otherwise provide `binary_path` and
  `parhplot_path` to `hysplit_dispersion()`.
- Windows uses socket clusters (`parLapply`). Set `mc.cores` to control parallelism.

## Support matrix

| Platform | R | HYSPLIT binaries | Notes |
|---|---|---|---|
| macOS (Intel) | >= 4.1 | splitr | Supported; works out of the box |
| macOS (Apple Silicon) | >= 4.1 | splitr via Rosetta or custom | Install Rosetta or supply `binary_path`/`parhplot_path` |
| Windows 10/11 | >= 4.1 | splitr | Supported; uses socket clusters |
| Linux x86_64 | >= 4.1 | splitr | Supported; ensure system libs for sf/terra |
| Linux ARM/aarch64 | >= 4.1 | Custom | splitr binaries not provided; supply your own |

Other OS versions may work but are not guaranteed. System libraries required by
sf/terra (GDAL/GEOS/PROJ) must be available on the host system.

## Setup checklist (minimize friction)

- Run `create_dirs()` in every new R session before calling `get_data()`.
- Use `get_data(data = "all", ...)` to fetch ZCTA, crosswalk, PBL, and met data.
- Install `splitr` for bundled HYSPLIT binaries, or set `binary_path` and
  `parhplot_path` explicitly.
- Run `check_spatial_packages()` to confirm sf/terra readiness.
- Run `validate_pipeline()` after a run to summarize outputs and catch gaps.

## Performance tips

- Keep `mc.cores` low on laptops; increase on servers via
  `options(disperseR.mc.cores = ...)`.
- Store project data on a local SSD to reduce I/O overhead.
- Use short date ranges for iteration; expand to full periods once stable.
- Reuse existing outputs with `overwrite = FALSE`.

## Documentation

- Main vignette: `vignette("Vignette_DisperseR")`
- Migration guide: `?migration_guide`
- Additional vignettes in `vignettes/` (render with `rmarkdown::render()`)

## System requirements

- R >= 4.1.0
- sf >= 1.0-0
- terra >= 1.7-0
- Network access for meteorology downloads

## Citation

```
Henneman, L., Choirat, C., & Garbulinska, M. (2019). disperseR:
An R package for HYSPLIT dispersion modeling and ZIP code-level
exposure assessment. R package version 0.2.0.
https://github.com/josbyb2020/disperseR-test2026
```
